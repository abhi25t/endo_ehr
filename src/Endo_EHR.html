<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIG Endoscopy Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .loc-column { min-height: 320px; max-height: 420px; overflow:auto; }
    .pill, .attr-pill {
      cursor:pointer; border:1px solid #93c5fd; background:#fff;
      color:#1e40af; padding:.35rem .6rem; border-radius:.5rem;
      font-size:.875rem; transition:all .15s;
    }
    .pill:hover, .attr-pill:hover { background:#eff6ff; }
    .pill-selected, .attr-pill.selected {
      background:#2563eb; color:#fff; border-color:#1d4ed8;
    }
    .left-disease {
      display:block; text-align:left; width:100%;
      padding:.5rem .75rem; border-radius:.5rem;
      border:1px solid transparent; background:#fff; color:#1f2937;
    }
    .left-disease:hover { background:#f1f5f9; }
    .left-disease.selected {
      background:#2563eb; color:#fff; border-color:#1e40af;
    }
    #sentencesEditor h1 { font-size: 2em; font-weight: bold; }
    #sentencesEditor h2 { font-size: 1.5em; font-weight: bold; margin-top: 0.5em; }
    #sentencesEditor h3 { font-size: 1.17em; font-weight: bold; margin-top: 0.3em; }
    #sentencesEditor p { margin-bottom: 0.5em; }

    /* Portrait mode: greyed-out elements */
    .left-disease.portrait-greyed, .pill.portrait-greyed {
      opacity: 0.35; cursor: not-allowed;
    }
    /* Portrait mode: focused disease (selected but not yet added to report) */
    .left-disease.portrait-focused {
      border-color: #3b82f6; background: #eff6ff;
    }

    /* Settings toggle switch */
    .toggle-switch { width: 2.75rem; height: 1.5rem; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.2s; }
    .toggle-knob { position: absolute; top: 2px; left: 2px; width: 1.15rem; height: 1.15rem; border-radius: 9999px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
    .toggle-switch.active .toggle-knob { transform: translateX(1.25rem); }

    /* ── Dark mode overrides ── */
    body.dark { background-color: #111827 !important; color: #f3f4f6 !important; }
    body.dark .bg-white { background-color: #1f2937 !important; }
    body.dark .bg-gray-100 { background-color: #111827 !important; }
    body.dark .bg-gray-50 { background-color: #374151 !important; }
    body.dark .bg-blue-50 { background-color: #1e3a5f !important; }
    body.dark .text-gray-800 { color: #f3f4f6 !important; }
    body.dark .text-gray-700 { color: #d1d5db !important; }
    body.dark .text-gray-600 { color: #d1d5db !important; }
    body.dark .text-gray-500 { color: #9ca3af !important; }
    body.dark .text-gray-400 { color: #9ca3af !important; }
    body.dark .text-blue-700 { color: #60a5fa !important; }
    body.dark .text-blue-600 { color: #60a5fa !important; }
    body.dark .text-yellow-700 { color: #fbbf24 !important; }
    body.dark .border { border-color: #4b5563 !important; }
    body.dark .border-gray-200 { border-color: #4b5563 !important; }
    body.dark .border-blue-200 { border-color: #2563eb !important; }
    body.dark .shadow { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.4) !important; }
    body.dark input, body.dark textarea, body.dark select {
      background-color: #374151 !important; color: #f3f4f6 !important; border-color: #6b7280 !important;
    }
    body.dark .pill, body.dark .attr-pill {
      background: #374151; color: #93c5fd; border-color: #3b82f6;
    }
    body.dark .pill:hover, body.dark .attr-pill:hover { background: #4b5563; }
    body.dark .pill-selected, body.dark .attr-pill.selected {
      background: #2563eb; color: #fff; border-color: #3b82f6;
    }
    body.dark .left-disease {
      background: #374151; color: #f3f4f6;
    }
    body.dark .left-disease:hover { background: #4b5563; }
    body.dark .left-disease.portrait-focused { border-color: #3b82f6; background: #1e3a5f; }
    body.dark .left-disease.selected {
      background: #2563eb; color: #fff; border-color: #3b82f6;
    }
    body.dark .hover\:bg-gray-200:hover { background-color: #4b5563 !important; }
    body.dark .ql-toolbar { background-color: #1f2937 !important; border-color: #4b5563 !important; }
    body.dark .ql-toolbar .ql-stroke { stroke: #d1d5db !important; }
    body.dark .ql-toolbar .ql-fill { fill: #d1d5db !important; }
    body.dark .ql-toolbar .ql-picker-label { color: #d1d5db !important; }
    body.dark .ql-container { background-color: #1f2937 !important; border-color: #4b5563 !important; color: #f3f4f6 !important; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
<div class="max-w-full mx-auto p-6 relative">
  <h1 id="pageTitle" class="text-2xl font-bold text-center text-blue-700 mb-6">AIG Endoscopy Report</h1>

  <!-- Settings Gear Button -->
  <div class="absolute top-6 right-6 z-50">
    <button id="settingsGearBtn" class="p-2 rounded-full hover:bg-gray-200 text-gray-600 text-xl" title="Settings">
      &#9881;
    </button>
    <div id="settingsPanel" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border p-4 z-50">
      <!-- Procedure Type -->
      <div class="mb-4 pb-3 border-b">
        <div class="text-sm font-medium text-gray-700 mb-2">Procedure Type</div>
        <div class="flex gap-4">
          <label class="flex items-center gap-1.5 text-sm cursor-pointer">
            <input type="radio" name="procedureType" value="endoscopy" checked class="accent-blue-600" /> Endoscopy
          </label>
          <label class="flex items-center gap-1.5 text-sm cursor-pointer">
            <input type="radio" name="procedureType" value="colonoscopy" class="accent-blue-600" /> Colonoscopy
          </label>
        </div>
      </div>
      <!-- Dark Mode Toggle -->
      <div class="flex items-center justify-between mb-4 pb-3 border-b">
        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
          <span class="text-lg">&#9790;</span> Dark Mode
        </label>
        <div id="darkModeToggle" class="toggle-switch bg-gray-300">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <!-- Study Type -->
      <div class="mb-4 pb-3 border-b">
        <div class="text-sm font-medium text-gray-700 mb-2">Study Type</div>
        <div class="flex gap-4">
          <label class="flex items-center gap-1.5 text-sm cursor-pointer">
            <input type="radio" name="studyType" value="retrospective" checked class="accent-blue-600" /> Retrospective
          </label>
          <label class="flex items-center gap-1.5 text-sm cursor-pointer">
            <input type="radio" name="studyType" value="prospective" class="accent-blue-600" /> Prospective
          </label>
        </div>
      </div>
      <!-- Display Mode -->
      <div class="mb-4 pb-3 border-b">
        <div class="text-sm font-medium text-gray-700 mb-2">Display Mode</div>
        <div class="flex gap-4">
          <label id="landscapeLabel" class="flex items-center gap-1.5 text-sm cursor-pointer">
            <input type="radio" name="displayMode" value="landscape" checked class="accent-blue-600" /> Landscape
          </label>
          <label class="flex items-center gap-1.5 text-sm cursor-pointer">
            <input type="radio" name="displayMode" value="portrait" class="accent-blue-600" /> Portrait
          </label>
        </div>
      </div>
      <!-- CSV File -->
      <div>
        <div class="text-sm font-medium text-gray-700 mb-2">CSV Menu File</div>
        <div class="text-xs text-gray-500 mb-1" id="csvAutoStatus"></div>
        <input id="csvFile" type="file" accept=".csv" class="text-sm w-full" />
        <button id="loadSample" class="mt-1 px-3 py-1 rounded border text-sm bg-white hover:bg-gray-50 w-full">Load sample</button>
      </div>
    </div>
  </div>

  <!-- Retrospective Controls -->
  <div id="retroControls" class="mb-3 bg-white p-4 rounded shadow">
    <div class="flex items-center gap-6 flex-wrap">
      <!-- Load Videos Folder Button -->
      <button id="loadVideoFolder" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
        Load Videos Folder
      </button>

      <!-- UHID Dropdown -->
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">UHID:</label>
        <select id="uhidSelect" class="border rounded p-2 text-sm min-w-[150px]">
          <option value="">-- Select UHID --</option>
        </select>
      </div>

      <!-- Video Dropdown -->
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Video:</label>
        <select id="videoSelect" class="border rounded p-2 text-sm min-w-[200px]" disabled>
          <option value="">-- Select Video --</option>
        </select>
      </div>

      <!-- Frame Range Inputs -->
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Start Frame:</label>
        <input type="number" id="startFrame" class="border rounded p-2 text-sm w-24" min="0" step="1" placeholder="0" />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">End Frame:</label>
        <input type="number" id="endFrame" class="border rounded p-2 text-sm w-24" min="0" step="1" placeholder="0" />
      </div>

      <!-- Frame Count and Duration Display -->
      <div class="flex items-center gap-4 text-sm">
        <span class="text-gray-700"># Frames: <strong id="frameCount">0</strong></span>
        <span class="text-gray-700">Duration: <strong id="durationSec">0.00</strong> sec</span>
      </div>

      <!-- Segmentation Frame Input -->
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Segmentation Frame:</label>
        <input type="number" id="segmentationFrame" class="border rounded p-2 text-sm w-24" min="0" step="1" placeholder="0" />
      </div>

      <!-- PII Pill Toggle -->
      <button id="piiToggle" class="px-3 py-2 rounded text-sm border-2 border-orange-400 bg-white text-orange-600 hover:bg-orange-50">
        PII
      </button>
    </div>
  </div>

  <!-- Prospective Controls (hidden by default) -->
  <div id="prospControls" class="mb-3 bg-white p-4 rounded shadow hidden">
    <div class="flex items-center gap-6 flex-wrap">
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">UHID:</label>
        <input type="text" id="prospUhid" class="border rounded p-2 text-sm w-32" placeholder="UHID" />
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Patient Name:</label>
        <input type="text" id="prospPatientName" class="border rounded p-2 text-sm w-48" placeholder="Name" />
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Gender:</label>
        <input type="text" id="prospGender" class="border rounded p-2 text-sm w-24" placeholder="M/F" />
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Age:</label>
        <input type="text" id="prospAge" class="border rounded p-2 text-sm w-20" placeholder="Age" />
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700">Indication:</label>
        <input type="text" id="prospIndication" class="border rounded p-2 text-sm w-64" placeholder="Indication for procedure" />
      </div>
    </div>
  </div>

  <!-- Shared Controls (Voice) - always visible -->
  <div id="sharedControls" class="mb-3 bg-white p-4 rounded shadow">
    <div class="flex items-center gap-6 flex-wrap">
      <!-- Voice Dictation Toggle -->
      <button id="voiceToggle" disabled
        class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
        title="Load CSV first">
        Start Dictation
      </button>
      <span id="voiceStatus" class="text-sm text-gray-500"></span>
    </div>
    <div id="csvNote" class="text-sm text-yellow-700 mt-2"></div>
    <!-- Voice Transcript Bar -->
    <div id="voiceTranscriptBar" class="hidden mt-2 px-3 py-2 bg-gray-50 rounded border border-gray-200 flex items-center gap-2">
      <span class="text-xs font-medium text-gray-500 shrink-0">Transcript:</span>
      <span id="voiceTranscriptText" class="text-sm truncate text-gray-400 italic"></span>
    </div>
  </div>

  <div id="mainLayout" class="flex gap-6">
    <!-- LEFT -->
    <div id="leftPane" class="w-3/4 space-y-4">
      <div id="diseaseGridCard" class="bg-white p-4 rounded shadow">
        <div id="diseaseColumnsGrid" class="grid grid-cols-4 gap-4">
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">Esophagus</h3>
            <div id="col-esophagus" class="loc-column space-y-2"></div>
          </div>
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">GE Junction</h3>
            <div id="col-gejunction" class="loc-column space-y-2"></div>
          </div>
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">Stomach</h3>
            <div id="col-stomach" class="loc-column space-y-2"></div>
          </div>
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">Duodenum</h3>
            <div id="col-duodenum" class="loc-column space-y-2"></div>
          </div>
        </div>
        <div id="sublocSection" class="mt-4 bg-blue-50 p-4 rounded">
          <div class="font-medium mb-2 text-sm text-gray-700">
            Sub-Location <span class="text-xs italic text-gray-500">(multi-select)</span>
          </div>
          <div id="subloc-chips" class="flex gap-2 flex-wrap"></div>
        </div>
      </div>

      <div id="detailsCard" class="bg-white p-4 rounded shadow hidden">
        <div class="mb-3">
          <div class="text-lg font-semibold" id="detailsTitle">Details</div>
          <div class="text-sm text-gray-500" id="detailsSubTitle"></div>
        </div>

        <!-- Disease-specific Frame Controls -->
        <div id="diseaseFrameBar" class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
          <div class="flex items-center gap-4 flex-wrap">
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700">Start Frame:</label>
              <input type="number" id="diseaseStartFrame" class="border rounded p-1 text-sm w-20" min="0" step="1" placeholder="0" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700">End Frame:</label>
              <input type="number" id="diseaseEndFrame" class="border rounded p-1 text-sm w-20" min="0" step="1" placeholder="0" />
            </div>
            <div class="flex items-center gap-3 text-sm">
              <span class="text-gray-700"># Frames: <strong id="diseaseFrameCount">0</strong></span>
              <span class="text-gray-700">Duration: <strong id="diseaseDurationSec">0.00</strong> sec</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700">Segmentation Frame:</label>
              <input type="number" id="diseaseSegmentationFrame" class="border rounded p-1 text-sm w-20" min="0" step="1" placeholder="0" />
            </div>
          </div>
        </div>

        <div id="detailsSections" class="space-y-4"></div>
        <div class="mt-4">
          <label class="block font-medium mb-1">Additional Comments</label>
          <textarea id="diseaseComments" rows="3" class="w-full p-2 border rounded" placeholder="Comments..."></textarea>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div id="rightPane" class="w-1/4">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold">Report</h2>
          <div class="flex gap-2">
            <button id="saveJSON" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Save</button>
            <button id="loadSavedJSON" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Load Saved JSON</button>
            <button id="clearReport" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Clear</button>
          </div>
        </div>
        <div id="reportContent" class="space-y-4 min-h-[40vh]"></div>
      </div>
      <div class="bg-white mt-4 p-4 rounded shadow">
        <label class="block font-medium mb-1">Overall Remarks</label>
        <textarea id="overallRemarks" rows="4" class="w-full p-2 border rounded" placeholder="Overall remarks"></textarea>
      </div>
      <div class="mt-4">
        <button id="generateSentencesReport"
          class="w-full bg-indigo-600 text-white px-4 py-3 rounded text-sm font-semibold hover:bg-indigo-700">
          Generate Sentences Report
        </button>
      </div>
    </div>
  </div>
</div>

<!-- hidden file input for loading saved JSON -->
<input id="jsonFile" type="file" accept="application/json, .json" style="display:none" />

<script src="js/01-debug.js"></script>
<script src="js/02-csv-parser.js"></script>
<script src="js/03-hint-helpers.js"></script>
<script src="js/04-input-helpers.js"></script>
<script src="js/05-constants.js"></script>
<script src="js/06-state.js"></script>
<script src="js/07-conditional-logic.js"></script>
<script src="js/08-disease-columns.js"></script>
<script src="js/09-sublocation-ui.js"></script>
<script src="js/10-disease-management.js"></script>
<script src="js/11-details-pane.js"></script>
<script src="js/12-report-pane.js"></script>
<script src="js/13-retro-video.js"></script>
<script src="js/14-json-io.js"></script>
<script src="js/15-pdf-generation.js"></script>
<script src="js/16-save-report.js"></script>
<script src="js/17-csv-upload.js"></script>
<script src="js/18-init.js"></script>
<script src="js/19-voice.js"></script>
<script src="js/20-sentences-report.js"></script>
<script src="js/21-settings.js"></script>
</body>
</html>
